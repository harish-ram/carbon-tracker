# Firestore Database Structure

Your application now saves all emission records to Firebase Firestore instead of localStorage. Data is organized per user and synced automatically.

## Database Organization

```
firestore (root)
â”‚
â””â”€â”€ users (collection)
    â”‚
    â”œâ”€â”€ {userId} (document - auto-generated by Firebase Auth)
    â”‚   â”œâ”€â”€ email: string
    â”‚   â”œâ”€â”€ displayName: string
    â”‚   â”œâ”€â”€ createdAt: timestamp
    â”‚   â”œâ”€â”€ updatedAt: timestamp
    â”‚   â”‚
    â”‚   â””â”€â”€ records (subcollection)
    â”‚       â”‚
    â”‚       â”œâ”€â”€ {recordId} (document - auto-generated)
    â”‚       â”‚   â”œâ”€â”€ month: string (e.g., "12")
    â”‚       â”‚   â”œâ”€â”€ year: number (e.g., 2025)
    â”‚       â”‚   â”œâ”€â”€ category: string (electricity, fuel, water, waste, travel)
    â”‚       â”‚   â”œâ”€â”€ value: number
    â”‚       â”‚   â”œâ”€â”€ unit: string (kWh, liters, mÂ³, kg, km, etc.)
    â”‚       â”‚   â”œâ”€â”€ co2e: number (COâ‚‚ equivalent in kg)
    â”‚       â”‚   â”œâ”€â”€ notes: string
    â”‚       â”‚   â”œâ”€â”€ timestamp: timestamp
    â”‚       â”‚   â”œâ”€â”€ createdAt: timestamp
    â”‚       â”‚   â””â”€â”€ updatedAt: timestamp
    â”‚       â”‚
    â”‚       â”œâ”€â”€ {recordId} (another record)
    â”‚       â””â”€â”€ ...
    â”‚
    â””â”€â”€ {anotherUserId} (another user's data)
        â””â”€â”€ ...
```

## How It Works

### 1. **User Registration**
When a user signs up:
- Firebase Authentication creates a user account
- A user document is automatically created in Firestore at `users/{userId}`
- User's email and display name are stored

### 2. **Adding Records**
When a user adds an emission record:
- Record is saved to `users/{userId}/records/{recordId}`
- Each record is a separate document with a unique ID
- Records include timestamps for tracking

### 3. **Loading Records**
When a user logs in:
- All records are loaded from `users/{userId}/records`
- Records are sorted by year and month (newest first)
- Data is displayed in the dashboard

### 4. **Updating/Deleting Records**
- Updates modify the specific record document
- Deletes remove the document from Firestore
- Changes sync immediately

## Benefits

âœ… **Multi-Device Access** - Data syncs across all devices
âœ… **User Isolation** - Each user only sees their own data
âœ… **Automatic Backup** - Data stored securely in the cloud
âœ… **Real-time Updates** - Changes reflect immediately
âœ… **Scalability** - Handles unlimited users and records
âœ… **No Local Storage Limits** - No browser storage restrictions

## Viewing Your Data

### Firebase Console
1. Go to: https://console.firebase.google.com/
2. Select project: `smart-carbon-tracker`
3. Click **Firestore Database** in the left menu
4. Browse collections:
   - `users` â†’ Click a user document
   - `records` â†’ View emission records for that user

### Data Format Example

**User Document** (`users/abc123`):
```json
{
  "email": "user@example.com",
  "displayName": "John Doe",
  "createdAt": "December 2, 2025 at 10:30:00 AM UTC+5:30",
  "updatedAt": "December 2, 2025 at 10:30:00 AM UTC+5:30"
}
```

**Record Document** (`users/abc123/records/xyz789`):
```json
{
  "month": "12",
  "year": 2025,
  "category": "electricity",
  "value": 1500,
  "unit": "kWh",
  "co2e": 945.5,
  "notes": "Auto-calculated from electricity",
  "timestamp": "December 2, 2025 at 11:45:00 AM UTC+5:30",
  "createdAt": "December 2, 2025 at 11:45:00 AM UTC+5:30",
  "updatedAt": "December 2, 2025 at 11:45:00 AM UTC+5:30"
}
```

## Security Rules

Your Firestore database should have the following security rules:

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Users can only read/write their own data
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      
      // Users can only access their own records
      match /records/{recordId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }
  }
}
```

To set these rules:
1. Go to Firebase Console â†’ Firestore Database â†’ Rules
2. Paste the above rules
3. Click **Publish**

## Migration from localStorage

If you had data in localStorage before:
- Old data will remain in localStorage
- New data is saved to Firestore
- You can manually re-enter old data through the Data Entry page
- Or create a migration script to bulk import

## Performance

- **Reads**: Fetched once on login, cached in memory
- **Writes**: Saved immediately to Firestore
- **Queries**: Optimized with indexes (year, month)
- **Cost**: Free tier includes 50K reads, 20K writes per day

## Troubleshooting

### Records not appearing?
- Check if user is logged in
- Open browser console for errors
- Verify Firebase credentials in `.env`
- Check Firestore security rules

### "Permission denied" error?
- Security rules might be too restrictive
- Make sure user is authenticated
- Verify `userId` matches auth user

### Data not syncing?
- Check internet connection
- Verify Firebase project is active
- Check browser console for errors

---

Your emission records are now safely stored in the cloud! ğŸŒ±â˜ï¸
